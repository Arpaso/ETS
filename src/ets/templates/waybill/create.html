{% extends "order/detail.html" %}
{% load i18n uni_form_tags %}

{% block title %}{% trans "Waybill Creation" %}{% endblock %}

{% block extra_content %}
<div class="form">

{% if form.errors or formset.errors %}<span style="color:red;">{% trans "You have some errors. Correct them" %}</span>{% endif %}

<form method="POST" action="" class="uniForm">{% csrf_token %}
    {% include "uni_form/errors_formset.html" %}
    <fieldset>
    <legend>{% trans "Loading details" %}</legend>    
    <table id="loadingdetails">
      {{ formset.management_form }}
      <thead class="bordered">
        <tr>
          <th>{% trans "Stock item" %}</th>
          <th>{% trans "Number of Units" %}</th>
          <th>{% trans "Overloaded Units" %}</th>
          {% if formset.can_delete %}<th style="background-color: red;">{% trans "Delete" %}</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for form in formset %}
          <tr colspan="{% if formset.can_delete %}7{% else %}6{% endif %}">{% include "uni_form/errors.html" %}</tr>
          <tr>
            <td>{% include "uni_form/uni_field.html" with field=form.stock_item %} {{ form.slug }}</td>
            <td>{% include "uni_form/uni_field.html" with field=form.number_of_units %}</td>
            <td>{% include "uni_form/uni_field.html" with field=form.overloaded_units %}</td>
            {% if formset.can_delete %}<th>{{ form.DELETE }}</th>{% endif %}
          </tr>
        {% endfor %}
        
        {# empty image formset form #}
        <tr class="etalon">
          <td>{% include "uni_form/uni_field.html" with field=formset.empty_form.stock_item %}</td>
          <td>{% include "uni_form/uni_field.html" with field=formset.empty_form.number_of_units %}</td>
          <td>{% include "uni_form/uni_field.html" with field=formset.empty_form.overloaded_units %}</td>
          {% if formset.can_delete %}<th>{{ formset.empty_form.DELETE }}</th>{% endif %}
        </tr>
      
      </tbody>
    </table>
    <a href="#" class="items-add-more" id="add-item-link">{% trans "Append more items" %}</a>
    </fieldset>
    {% uni_form form form.helper %}
    <div class="buttonHolder">
      <input type="submit" name="add" value="{% trans 'Save' %}"/>
    </div>
</form>
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script charset="utf-8" type="text/javascript">

(function($) {
	  $.fn.formset = function(addLink, etalonClass, countFormsField, success) {
	    var container = $(this);
	    var etalon = container.find('.'+etalonClass);
	    
	    addLink.click(function(){
	       var empty_form = etalon.clone();
	       var count_forms = countFormsField.val();

	       empty_form.find('div, select, input').each(function(index, domEle){
	         var el = $(domEle);
	         if (el.attr('id')) 
	        	 el.attr('id', el.attr('id').replace('__prefix__', count_forms));
	         if (el.attr('name')) 
	        	 el.attr('name', el.attr('name').replace('__prefix__', count_forms));
	       });
	       countFormsField.val(parseInt(count_forms) + 1);
	       var holder = empty_form.removeClass(etalonClass).insertBefore(etalon);
	       
	       if (success) success(holder);
	       return false;
	    });
	  };
	})(jQuery);

$(document).ready(function() {
  $('#{{ form.dispatch_date.auto_id }}').datepicker({ minDate: 0, dateFormat: 'yy-mm-dd' });
  $('#{{ form.loading_date.auto_id }}').datepicker({ minDate: 0, dateFormat: 'yy-mm-dd' });
  
  $("#loadingdetails").formset($("#add-item-link"), 'etalon', 
		  $('#{{ formset.management_form.TOTAL_FORMS.auto_id }}'));
  
});
$(document).keydown(omit_enter);
</script>
{% endblock %}
